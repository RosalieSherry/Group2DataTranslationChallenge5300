---
title: "Project Code"
author: "Group 2 "
date: "3/14/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r Load Libraries}
library(tidyverse)
library(ipumsr)
library(lubridate)
library(vtable)
library(haven)
library(dplyr)
library(estimatr)
library(car)
library(jtools)
library(scales)
library(stringr)
library(ggplot2)
library(Hmisc)


```

```{r Load source code}

##Lynna's Code 
source("/Users/lynnatran/Documents/MSBA/5300 - Econometrics/Data Translation Challenge/Git Repository/Group2DataTranslationChallenge5300/code/Lynna-2RCodeforEmploymentVariables.R")
```

```{r Load source code}
##Lala's Code 
source("/Users/lynnatran/Documents/MSBA/5300 - Econometrics/Data Translation Challenge/Git Repository/Group2DataTranslationChallenge5300/code/03_g2_dtc_tidy_data.R")
```

```{r Load source code}
##Rosalie's Code 
source("/Users/lynnatran/Documents/MSBA/5300 - Econometrics/Data Translation Challenge/Git Repository/Group2DataTranslationChallenge5300/code/Yeehaw.R")

```



```{r Adding primary keys to datasets}
employment_df$household_personid <- paste(employment_df$YEAR, employment_df$MONTH, employment_df$SERIAL, employment_df$PERNUM, sep="-")


displ_workers$household_personid <- paste(displ_workers$year, displ_workers$month, displ_workers$serial, displ_workers$pernum, sep="-")

covid_score$household_personid <- paste(covid_score$year, covid_score$month, covid_score$serial, covid_score$pernum, sep="-")

```



```{r joining datasets }

employment_displaced_df <- employment_df %>%
  full_join(displ_workers, by = 'household_personid')


vtable(employment_displaced_df)

```


```{r group by month to get a Retail Employment monthly statistic}

month_group_df <- employment_displaced_df %>%
  select(YEAR, MONTH, employed, retail, indname) %>%
  mutate(employed_binary = ifelse(employed == TRUE, 1, 0)) %>%
  mutate(retail_noNA = ifelse(is.na(retail) | retail == FALSE, FALSE, TRUE)) %>%
  mutate(retail_binary = ifelse(retail_noNA == TRUE, 1, 0)) %>%
  mutate(retail_employed = employed_binary == 1 & retail_binary == 1) %>%
  mutate(retail_employed_binary = ifelse(retail_employed == TRUE, 1, 0))
  

month_group_df$yearmo <- paste(month_group_df$YEAR, month_group_df$MONTH, sep="-")


month_group_count <- month_group_df %>%
count(YEAR, MONTH, yearmo)


month_group_df <- month_group_df %>%
  select(YEAR, MONTH, yearmo, employed, retail, employed_binary, retail_binary, retail_employed_binary) %>%
  group_by(YEAR, MONTH, yearmo) %>% 
  summarise(Employment = sum(employed_binary), Retail = sum(retail_binary),  RetailEmployed = sum(retail_employed_binary)) %>%
  mutate(afterCovid = (yearmo > '2020-3' | yearmo >= '2020-10')) %>%
  ##month_group_count %>%
  left_join(month_group_count, by =  'yearmo')## %>%
 ## summarise(Retail = sum((retail_binary)))
  ##still need an percentage in retail)

month_group_stats <- month_group_count %>%
  left_join(month_group_df, by =  'yearmo') %>%
  mutate(employment_rate = (Employment / n)*100 ) %>%
  ##mutate(retailemployment_rate = ((Retail/Employment)*employment_rate)) %>%
  ##otherindustryemployement_rate
  mutate(retail_rate = (Retail/n) *100) %>%
  mutate(retailemployment_rate = (RetailEmployed/n) *100) %>%
  filter(yearmo != 'NA-NA')
#   
##will need to check if its only employed people with retail jobs  


```
```{r pressure, echo=FALSE plotting month_group stats }
ggplot(data = month_group_stats, aes( x= yearmo, y = retailemployment_rate )) + geom_point()
```


```{r Employment Rate}
##month level
##gender : columns with female percentage, male percentage 
##age: group by age 

employment_regression <- lm(retailemployment_rate ~ employment_rate + retail_rate  +afterCovid, data = month_group_stats)

summary(employment_regression)

ggplot(data = employment_regression, aes( x= retailemployment_rate, y = employment_rate )) + geom_point()


##plot_coefs(employment_regression)

##histogram

hist(rstandard((employment_regression)), 
     xlab = "Standardized residuals", main = 'Standardized Residuals
     of ' )

##geom smooth
```

```{r trying out employment regression without rates }


employmentworates_regression <- lm(RetailEmployed ~ n +afterCovid, ##Employment + Retail, 
                                   data = month_group_df)

summary(employmentworates_regression)

ggplot(data = employmentworates_regression, aes( x= RetailEmployed, y = n )) + geom_point()


##plot_coefs(employment_regression)

##histogram

hist(rstandard((employmentworates_regression)), 
     xlab = "Standardized residuals", main = 'Standardized Residuals
     of ' )


```


```{r group by month to get a otherindustry monthly statistic}

# otherindustries_df <- employment_displaced_df %>%
#   filter(!is.na(indname)) %>%
#   select(YEAR, MONTH, employed, indname) %>%
#   mutate(employed_binary = ifelse(employed == TRUE, 1, 0)) %>%
#   mutate(artind = ifelse(indname == "Arts, Entertainment, and Recreation, and Accommodation and Food Services", 1,0))%>%
#   mutate(constructionind = ifelse(indname == "Construction", 1,0)) %>%
#   mutate(eduind = ifelse(indname == "Educational Services, and Health Care and Social Assistance", 1,0)) %>%
#   mutate(financeind = ifelse(indname == "Finance and Insurance, and Real Estate and Rental and Leasing", 1,0)) %>%
#   mutate(infoind =  ifelse(indname == "Information", 1,0)) %>%
#   mutate(mfind =ifelse(indname == "Manufacturing", 1,0)) %>%
#   mutate(militaryind = ifelse(indname == "Military", 1,0)) %>%
#   mutate(otherind = ifelse(indname == "Other Services, Except Public Administration", 1,0)) %>%
#   mutate(proind =  ifelse(indname == "Professional, Scientific, and Management, and Administrative and Waste Management Services", 1,0)) %>%
#   mutate(publicind =  ifelse(indname == "Public Administration", 1,0)) %>%
#   mutate(retailind = ifelse(indname == "Retail Trade", 1,0)) %>%
#   mutate(transportind = ifelse(indname == "Transportation and Warehousing, and Utilities", 1,0)) %>%
#   mutate(wsind = ifelse(indname == "Wholesale Trade", 1,0))


##trying employed + those industries
otherindustries_df <- employment_displaced_df %>%
  filter(!is.na(indname)) %>%
  select(YEAR, MONTH, employed, indname) %>%
  mutate(employed_binary = ifelse(employed == TRUE, 1, 0)) %>%
  mutate(artind = ifelse(employed_binary == 1 & indname == "Arts, Entertainment, and Recreation, and Accommodation and Food Services", 1,0))%>%
  mutate(constructionind = ifelse(employed_binary == 1 & indname == "Construction", 1,0)) %>%
  mutate(eduind = ifelse(employed_binary == 1 & indname == "Educational Services, and Health Care and Social Assistance", 1,0)) %>%
  mutate(financeind = ifelse(employed_binary == 1 & indname == "Finance and Insurance, and Real Estate and Rental and Leasing", 1,0)) %>%
  mutate(infoind =  ifelse(employed_binary == 1 & indname == "Information", 1,0)) %>%
  mutate(mfind =ifelse(employed_binary == 1 & indname == "Manufacturing", 1,0)) %>%
  mutate(militaryind = ifelse(employed_binary == 1 & indname == "Military", 1,0)) %>%
  mutate(otherind = ifelse(employed_binary == 1 & indname == "Other Services, Except Public Administration", 1,0)) %>%
  mutate(proind =  ifelse(employed_binary == 1 & indname == "Professional, Scientific, and Management, and Administrative and Waste Management Services", 1,0)) %>%
  mutate(publicind =  ifelse(employed_binary == 1 & indname == "Public Administration", 1,0)) %>%
  mutate(retailind = ifelse(employed_binary == 1 & indname == "Retail Trade", 1,0)) %>%
  mutate(transportind = ifelse(employed_binary == 1 & indname == "Transportation and Warehousing, and Utilities", 1,0)) %>%
  mutate(wsind = ifelse(employed_binary == 1 & indname == "Wholesale Trade", 1,0))

otherindustries_df$yearmo <- paste(otherindustries_df$YEAR, otherindustries_df $MONTH, sep="-")

  otherindustries_count <- otherindustries_df %>%
count(indname)

otherindustries_df <- otherindustries_df %>%
  group_by(YEAR, MONTH, yearmo) %>%
  summarise(Employment = sum(employed_binary),
            art_count = sum(artind),
            construction_count = sum(constructionind),
            edu_count = sum(eduind),
            finance_count = sum(financeind),
            info_count = sum(infoind),
            military_count = sum(militaryind),
            other_count = sum(otherind),
            pro_count = sum(proind),
            public_count = sum(publicind),
            retail_count = sum(retailind),
            transport_count = sum(transportind),
            ws_count = sum(wsind)
          )


otherindustries_df_stats <- otherindustries_df %>%
  left_join(month_group_count, by =  'yearmo') %>%
  mutate(employment_rate = (Employment / n)*100 ) %>%
  mutate(art_rate = (art_count / n)*100 ) %>%
  mutate(construction_rate = (construction_count / n)*100 ) %>%
  mutate(edu_rate = (edu_count / n)*100 ) %>%
  mutate(finance_rate = (finance_count / n)*100 ) %>%
  mutate(info_rate = (info_count / n)*100 ) %>%
  mutate(military_rate = (military_count / n)*100 ) %>%
  mutate(other_rate = (other_count / n)*100 ) %>%
  mutate(pro_rate = (pro_count / n)*100 ) %>%
  mutate(public_rate = (public_count / n)*100 ) %>%
  mutate(retail_rate = (retail_count / n)*100 ) %>%
  mutate(transport_rate = (transport_count / n)*100 ) %>%
  mutate(ws_rate = (ws_count / n)*100 ) %>%
  mutate(afterCovid = (yearmo > '2020-3' | yearmo >= '2020-10')) %>%
  filter(yearmo != 'NA-NA')


```

```{r plotting other industries}
 
ggplot(data = otherindustries_df_stats, aes( x = yearmo)) +
                                      geom_point(aes(y = art_rate), color = "darkred") +
                                      geom_point(aes(y = construction_rate), color = "red") +
                                      geom_point(aes(y = edu_rate), color = "pink") +
                                      geom_point(aes(y = finance_rate), color = "orange") +
                                      geom_point(aes(y = info_rate), color = "yellow") +
                                      geom_point(aes(y = military_rate), color = "green") +
                                      geom_point(aes(y = other_rate), color = "blue") +
                                      geom_point(aes(y = public_rate), color = "purple") +
                                      geom_point(aes(y = retail_rate), color = "brown") +
                                      geom_point(aes(y = transport_rate), color = "blueviolet") +
                                      geom_point(aes(y = ws_rate), color = "gold")
                                    
                                      

```
```{r other industries regression}

otherindustries_regression <- lm(employment_rate ~ art_rate + construction_rate + edu_rate
                                 + finance_rate + info_rate + military_rate + other_rate
                                 + pro_rate + public_rate + retail_rate + transport_rate + ws_rate 
                                 + afterCovid, data = otherindustries_df_stats)

summary(otherindustries_regression)

ggplot(data = otherindustries_regression, aes( x= employment_rate)) +
                                      geom_point(aes(y = art_rate), color = "darkred") +
                                      geom_point(aes(y = construction_rate), color = "red") +
                                      geom_point(aes(y = edu_rate), color = "pink") +
                                      geom_point(aes(y = finance_rate), color = "orange") +
                                      geom_point(aes(y = info_rate), color = "yellow") +
                                      geom_point(aes(y = military_rate), color = "green") +
                                      geom_point(aes(y = other_rate), color = "blue") +
                                      geom_point(aes(y = public_rate), color = "purple") +
                                      geom_point(aes(y = retail_rate), color = "brown") +
                                      geom_point(aes(y = transport_rate), color = "blueviolet") +
                                      geom_point(aes(y = ws_rate), color = "gold")



##plot_coefs(employment_regression)

##histogram

hist(rstandard((otherindustries_regression)), 
     xlab = "Standardized residuals", main = 'Standardized Residuals
     of ' )

##geom smooth

```


```{r COVID Data}
##Question 3 : r covid variables – compared to our demographics

##We can answer a question like : Women has been less affected by COVID therefore they should be targets 

covidemployment_df <- employment_displaced_df 

person_covid <- covid_score %>%
  left_join(covidemployment_df, by = 'household_personid' )

```

```{r COVID DATA}

ggplot(data = person_covid, aes( x= covid_score, y = employed )) + geom_point()

```


## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}

```


